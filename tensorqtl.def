BootStrap: docker
From: nvidia/cuda:10.2-cudnn7-runtime-ubuntu18.04
IncludeCmd: yes

%help

%setup

%files

%labels

%environment

%post

    apt-get update && apt-get install -y software-properties-common && \
        apt-get update && apt-get install -y \
            apt-transport-https \
            build-essential \
            cmake \
            curl \
            libboost-all-dev \
            libbz2-dev \
            libcurl3-dev \
            liblzma-dev \
            libncurses5-dev \
            libssl-dev \
            python3.8 \
            python3.8-dev \
            python3.8-distutils \
            python3.8-venv \
            python3-pip \
            sudo \
            unzip \
            wget \
            zlib1g-dev \
            git \
    && rm -rf /var/lib/apt/lists/* /var/tmp/* && \
    apt-get clean && \
    apt-get autoremove -y && \
    rm -rf /var/lib/{apt,dpkg,cache,log}/

    python3.8 -m pip install pip

    # htslib
    cd /opt && \
        wget --no-check-certificate https://github.com/samtools/htslib/releases/download/1.10.2/htslib-1.10.2.tar.bz2 && \
        tar -xf htslib-1.10.2.tar.bz2 && rm htslib-1.10.2.tar.bz2 && cd htslib-1.10.2 && \
        ./configure --enable-libcurl --enable-s3 --enable-plugins --enable-gcs && \
        make && make install && make clean

    # bcftools
    cd /opt && \
        wget --no-check-certificate https://github.com/samtools/bcftools/releases/download/1.10.2/bcftools-1.10.2.tar.bz2 && \
        tar -xf bcftools-1.10.2.tar.bz2 && rm bcftools-1.10.2.tar.bz2 && cd bcftools-1.10.2 && \
        ./configure --with-htslib=system && make && make install && make clean

    # install R
    # instructions: https://ftp.osuosl.org/pub/cran/
    export DEBIAN_FRONTEND=noninteractive
    # update indices
    apt update -qq
    # install two helper packages we need
    apt install --no-install-recommends software-properties-common dirmngr
    # add the signing key (by Michael Rutter) for these repos
    # To verify key, run gpg --show-keys /etc/apt/trusted.gpg.d/cran_ubuntu_key.asc 
    # Fingerprint: 298A3A825C0D65DFD57CBB651716619E084DAB9
    wget -qO- https://cloud.r-project.org/bin/linux/ubuntu/marutter_pubkey.asc | sudo tee -a /etc/apt/trusted.gpg.d/cran_ubuntu_key.asc
    # add the R 4.0 repo from CRAN -- adjust 'focal' to 'groovy' or 'bionic' as needed
    add-apt-repository "deb https://cloud.r-project.org/bin/linux/ubuntu $(lsb_release -cs)-cran40/"
    apt install -y --no-install-recommends r-base r-base-dev
    Rscript -e 'if (!requireNamespace("BiocManager", quietly = TRUE)) {install.packages("BiocManager")}; BiocManager::install("qvalue");'

    # python modules
    python3.8 -m pip install --upgrade pip setuptools
    python3.8 -m pip install numpy pandas scipy
    python3.8 -m pip install pandas-plink ipython jupyter matplotlib pyarrow torch rpy2 gcsfs

    cd /opt && \
        git clone https://github.com/porchard/tensorqtl.git && \
        chmod a+rx tensorqtl && \
        cd tensorqtl && \
        git checkout test && \
        python3.8 -m pip install -r install/requirements.txt .

    python3.8 -m pip cache purge
    apt-get clean
